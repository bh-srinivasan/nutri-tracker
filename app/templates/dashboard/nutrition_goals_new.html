{% extends "base.html" %}
{% block title %}Nutrition Goals{% endblock %}

{% block page_css %}
<style>
  .input-unit .input-group-text { min-width: 3.5rem; justify-content: center; }
  .calc-bar { display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
  .muted-hint { font-size:.9rem; color:#6c757d; }
</style>
{% endblock %}

{% block content %}

<h3 class="mb-1">Nutrition Goals</h3>
<p class="muted-hint mb-3">Set your target, pick a timeline, and let us estimate your daily plan.</p>
<p><a class="btn btn-outline-secondary btn-sm" href="{{ url_for('dashboard.index') }}">← Back to Dashboard</a></p>

{% if current_goal %}
  <div class="alert alert-info" role="alert">
    <strong>Current:</strong>
    {{ current_goal.target_calories }} kcal ·
    {{ current_goal.target_protein }}g P ·
    {{ current_goal.target_carbs }}g C ·
    {{ current_goal.target_fat }}g F
    {% if current_goal.target_fiber %} · {{ current_goal.target_fiber }}g Fiber{% endif %}
    {% if current_goal.target_date %} · Target {{ current_goal.target_date.strftime('%b %d, %Y') }}{% endif %}
  </div>
{% endif %}

<form method="POST" novalidate>
  {{ form.hidden_tag() }}

  <h5 class="mt-3">Personal Information</h5>
  <div class="row g-3">
    <div class="col-sm-6">
      <label class="form-label">{{ form.weight.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.weight(id="weight", class="form-control" + (" is-invalid" if form.weight.errors else "")) }}
        <span class="input-group-text">kg</span>
      </div>
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.height.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.height(id="height", class="form-control" + (" is-invalid" if form.height.errors else "")) }}
        <span class="input-group-text">cm</span>
      </div>
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.age.label.text }}</label>
      {{ form.age(id="age", class="form-control" + (" is-invalid" if form.age.errors else "")) }}
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.gender.label.text }}</label>
      {{ form.gender(id="gender", class="form-select" + (" is-invalid" if form.gender.errors else "")) }}
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.activity_level.label.text }}</label>
      {{ form.activity_level(id="activity_level", class="form-select" + (" is-invalid" if form.activity_level.errors else "")) }}
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.goal_type.label.text }}</label>
      {{ form.goal_type(id="goal_type", class="form-select" + (" is-invalid" if form.goal_type.errors else "")) }}
    </div>
  </div>

  <hr class="my-4">

  <h5 class="mb-2">Goal Timeline</h5>
  <div class="row g-3">
    <div class="col-sm-6">
      <label class="form-label">{{ form.target_weight.label.text }} <span class="text-muted">(optional)</span></label>
      <div class="input-group input-unit">
        {{ form.target_weight(id="target_weight", class="form-control", placeholder="Target (kg)") }}
        <span class="input-group-text">kg</span>
      </div>
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.target_duration.label.text }}</label>
      {{ form.target_duration(id="target_duration", class="form-select", onchange="updateTargetDate();") }}
    </div>
    <div class="col-sm-6">
      <label class="form-label">{{ form.target_date.label.text }}</label>
      {{ form.target_date(id="target_date", class="form-control" + (" is-invalid" if form.target_date.errors else ""), onchange="handleManualDateChange()") }}
    </div>
    <div class="col-sm-6 d-flex align-items-end">
      <div id="durationHint" class="muted-hint">Pick a duration or date. We'll compute a plan that fits your timeline.</div>
    </div>
  </div>

  <hr class="my-4">

  <div class="calc-bar my-2">
    <h5 class="m-0">Estimated Daily Targets</h5>
    <!-- REAL button (was plain text previously) -->
    <button type="button" id="btnCalculateGoals" class="btn btn-primary">
      <i class="bi bi-lightning-charge"></i> Calculate Estimated Goals
    </button>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <label class="form-label">{{ form.target_calories.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.target_calories(id="targetCalories", class="form-control" + (" is-invalid" if form.target_calories.errors else "")) }}
        <span class="input-group-text">kcal</span>
      </div>
    </div>
    <div class="col-md-6">
      <label class="form-label">{{ form.target_protein.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.target_protein(id="targetProtein", class="form-control" + (" is-invalid" if form.target_protein.errors else "")) }}
        <span class="input-group-text">g</span>
      </div>
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ form.target_carbs.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.target_carbs(id="targetCarbs", class="form-control" + (" is-invalid" if form.target_carbs.errors else "")) }}
        <span class="input-group-text">g</span>
      </div>
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ form.target_fat.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.target_fat(id="targetFat", class="form-control" + (" is-invalid" if form.target_fat.errors else "")) }}
        <span class="input-group-text">g</span>
      </div>
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ form.target_fiber.label.text }}</label>
      <div class="input-group input-unit">
        {{ form.target_fiber(id="targetFiber", class="form-control" + (" is-invalid" if form.target_fiber.errors else "")) }}
        <span class="input-group-text">g</span>
      </div>
    </div>
  </div>

  <div class="mt-3">
    {{ form.submit(class="btn btn-success btn-lg") }}
  </div>
</form>

{% endblock %}

{% block scripts %}
<script>
(function(){
  // --- constants / helpers ---
  const KCAL_PER_KG = 7700;
  const DEFAULT_LOSS_KG_PER_WEEK = 0.5;
  const DEFAULT_GAIN_KG_PER_WEEK = 0.25;
  const durationDaysMap = { '2_weeks':14,'1_month':30,'2_months':60,'3_months':90,'6_months':180,'1_year':365 };

  const byId = id => document.getElementById(id);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function parseNum(el){
    if(!el) return NaN;
    const raw = String(el.value||'').replace(/,/g,'').trim();
    const cleaned = raw.replace(/\s*(kg|cm|g|grams|kcal|calories)?$/i,'').trim();
    const n = parseFloat(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }
  const getNum = id => parseNum(byId(id));
  const getVal = id => byId(id)?.value || '';
  function setNum(id,v){
    const el = byId(id);
    if(!el || !Number.isFinite(v)) return;
    const val = Math.round(v);
    const write=()=>{ el.value=String(val); el.dispatchEvent(new Event('input',{bubbles:true})); el.dispatchEvent(new Event('change',{bubbles:true})); };
    write(); setTimeout(write,50); setTimeout(write,300);
  }

  const activityMap = { sedentary:1.2, light:1.375, moderate:1.55, high:1.725, very_high:1.9, active:1.725, very_active:1.9 };
  function calcBMR({gender,weight,height,age}){ return (gender==='male') ? 10*weight+6.25*height-5*age+5 : 10*weight+6.25*height-5*age-161; }

  function daysFromDurationOrDate(){
    const dur = getVal('target_duration'); const dateStr = getVal('target_date');
    const today = new Date(); const base = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    if(dateStr){ const dd = Math.ceil((new Date(dateStr)-base)/86400000); if(dd>0) return dd; }
    return durationDaysMap[dur] || null;
  }
  function dailyAdjustDefault(goalType, days){
    if(!days || days<=0) return 0;
    if(goalType==='lose'){ const tot = -(DEFAULT_LOSS_KG_PER_WEEK*(days/7)); return clamp((tot*KCAL_PER_KG)/days,-1000,1000); }
    if(goalType==='gain'){ const tot =  (DEFAULT_GAIN_KG_PER_WEEK*(days/7)); return clamp((tot*KCAL_PER_KG)/days,-1000,1000); }
    return 0;
  }

  function calculateGoals(){
    const weight=getNum('weight'), height=getNum('height'), age=getNum('age');
    const gender=getVal('gender'), activity=getVal('activity_level'), goalType=getVal('goal_type');
    if([weight,height,age].some(Number.isNaN) || !gender || !activity || !goalType){
      alert('Fill weight, height, age, gender, activity level, and goal type first.'); return;
    }
    const bmr  = calcBMR({gender,weight,height,age});
    const mult = activityMap[activity] ?? 1.2;
    const tdee = bmr * mult;

    const days = daysFromDurationOrDate();
    const targetWt = getNum('target_weight');
    let dailyAdjust = 0;

    if(Number.isFinite(targetWt) && days && days>0){
      const deltaKg = targetWt - weight;                 // negative for loss
      dailyAdjust = clamp((deltaKg*KCAL_PER_KG)/days, -1000, 1000);
    } else {
      const byPace = dailyAdjustDefault(goalType, days);
      dailyAdjust = (byPace !== 0) ? byPace : (goalType==='lose' ? -500 : goalType==='gain' ? 500 : 0);
    }

    let calories = clamp(tdee + dailyAdjust, 800, 5000);
    const protein = clamp(weight*2.2, 10, 300);
    const fat     = clamp((calories*0.25)/9, 0, 200);
    const carbs   = clamp((calories - protein*4 - fat*9)/4, 0, 500);
    const fiber   = clamp((calories/1000)*14, 0, 100);

    setNum('targetCalories', calories);
    setNum('targetProtein',  protein);
    setNum('targetFat',      fat);
    setNum('targetCarbs',    carbs);
    setNum('targetFiber',    fiber);

    const hint = byId('durationHint');
    if(hint){
      if(Number.isFinite(targetWt) && days) {
        hint.textContent = `Using duration-aware plan: Δ${(targetWt-weight).toFixed(1)}kg over ${days} days`;
      } else if (days) {
        const pace = (goalType==='lose') ? `-${DEFAULT_LOSS_KG_PER_WEEK} kg/week`
                   : (goalType==='gain') ? `+${DEFAULT_GAIN_KG_PER_WEEK} kg/week` : `0 kg/week`;
        hint.textContent = `Using default pace (${pace}) over ${days} days`;
      } else {
        hint.textContent = `Using legacy ±500 kcal/day (set duration or date for duration-aware plan)`;
      }
    }

    console.info('[Goals] calc ->', { tdee: Math.round(tdee), dailyAdjust: Math.round(dailyAdjust), calories: Math.round(calories) });
  }

  // Date helpers (also trigger calc)
  function updateTargetDate(){
    const dur = getVal('target_duration'); const dateInput = byId('target_date'); if(!dateInput){ calculateGoals(); return; }
    const days = { '2_weeks':14,'1_month':30,'2_months':60,'3_months':90,'6_months':180,'1_year':365 }[dur];
    if(!days){ calculateGoals(); return; }
    const now = new Date(); const d = new Date(now.getFullYear(), now.getMonth(), now.getDate()+days);
    try{ dateInput.valueAsDate = d; }catch(e){}
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    dateInput.value = `${yyyy}-${mm}-${dd}`;
    dateInput.dispatchEvent(new Event('input',{bubbles:true}));
    dateInput.dispatchEvent(new Event('change',{bubbles:true}));
    calculateGoals();
  }
  function handleManualDateChange(){ calculateGoals(); }

  // Expose for inline attributes already in the template
  window.updateTargetDate = updateTargetDate;
  window.handleManualDateChange = handleManualDateChange;
  window.calculateGoals = calculateGoals;

  // Wire events
  function wire(){
    const btn = byId('btnCalculateGoals');
    if(btn){ btn.onclick = null; btn.addEventListener('click', calculateGoals, { passive:true }); }
    // Live recalc on changes
    ['weight','height','age','gender','activity_level','goal_type','target_weight']
      .map(byId).filter(Boolean).forEach(el => el.addEventListener('change', calculateGoals));
    byId('target_duration')?.addEventListener('change', updateTargetDate);
    byId('target_date')?.addEventListener('change', handleManualDateChange);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', wire, { once:true });
  else wire();

})();
</script>
{% endblock %}
