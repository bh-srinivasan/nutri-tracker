{% extends "base.html" %} {% block title %}Nutrition Goals{% endblock %} {%
block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Nutrition Goals</h1>
        <a
          href="{{ url_for('dashboard.index') }}"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
      </div>

      <!-- Current Goals Display -->
      {% if current_goal %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-target"></i> Current Goals
            <small class="text-muted"
              >(Set on {{ current_goal.created_at.strftime('%B %d, %Y') }})</small
            >
          </h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3 mb-3">
              <div class="card bg-danger text-white">
                <div class="card-body py-3">
                  <div class="display-6">
                    {{ current_goal.target_calories }}
                  </div>
                  <small>Calories/day</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card bg-primary text-white">
                <div class="card-body py-3">
                  <div class="display-6">
                    {{ current_goal.target_protein }}g
                  </div>
                  <small>Protein/day</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card bg-success text-white">
                <div class="card-body py-3">
                  <div class="display-6">{{ current_goal.target_carbs }}g</div>
                  <small>Carbs/day</small>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3">
              <div class="card bg-warning text-white">
                <div class="card-body py-3">
                  <div class="display-6">{{ current_goal.target_fat }}g</div>
                  <small>Fat/day</small>
                </div>
              </div>
            </div>
          </div>
          {% if current_goal.target_fiber %}
          <div class="text-center mt-3">
            <span class="badge bg-info fs-6">
              <i class="fas fa-seedling"></i> {{ current_goal.target_fiber }}g
              Fiber/day
            </span>
          </div>
          {% endif %}
          {% if current_goal.target_weight %}
          <div class="text-center mt-3">
            <span class="badge bg-secondary fs-6">
              <i class="fas fa-weight"></i> {{ current_goal.target_weight }}kg
              Target Weight
            </span>
          </div>
          {% endif %}
          
          <!-- Goal Timing Information -->
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body text-center py-2">
                  <small class="text-muted">Goal Last Updated</small>
                  <div class="fw-bold">
                    {{ current_goal.goal_date.strftime('%B %d, %Y') if current_goal.goal_date else current_goal.created_at.strftime('%B %d, %Y') }}
                  </div>
                </div>
              </div>
            </div>
            {% if current_goal.target_date %}
            <div class="col-md-6">
              <div class="card bg-primary text-white">
                <div class="card-body text-center py-2">
                  <small>Target Completion Date</small>
                  <div class="fw-bold">
                    {{ current_goal.target_date.strftime('%B %d, %Y') }}
                  </div>
                  {% if current_goal.target_date < today %}
                  <small><i class="fas fa-exclamation-triangle"></i> Past due</small>
                  {% elif current_goal.target_date == today %}
                  <small><i class="fas fa-star"></i> Today!</small>
                  {% else %}
                  <small>{{ (current_goal.target_date - today).days }} days to go</small>
                  {% endif %}
                </div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Set New Goals Form -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-{{ 'edit' if current_goal else 'plus' }}"></i>
            {{ 'Update' if current_goal else 'Set' }} Nutrition Goals
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            <!-- Personal Information for Goal Calculation -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.weight.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.weight(id="weight", class="form-control" + (" is-invalid" if
                    form.weight.errors else "")) }}
                    <span class="input-group-text">kg</span>
                  </div>
                  {% if form.weight.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.weight.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.target_weight.label(class="form-label") }}
                  <span class="text-muted small">(Optional)</span>
                  <div class="input-group">
                    {{ form.target_weight(id="target_weight", class="form-control", placeholder="Enter your target weight") }}
                    <span class="input-group-text">kg</span>
                  </div>
                  {% if form.target_weight.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.target_weight.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.height.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.height(id="height", class="form-control" + (" is-invalid" if
                    form.height.errors else "")) }}
                    <span class="input-group-text">cm</span>
                  </div>
                  {% if form.height.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.height.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-4">
                <div class="mb-3">
                  {{ form.age.label(class="form-label") }} {{
                  form.age(id="age", class="form-control" + (" is-invalid" if
                  form.age.errors else "")) }} {% if form.age.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.age.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  {{ form.gender.label(class="form-label") }} {{
                  form.gender(id="gender", class="form-select" + (" is-invalid" if
                  form.gender.errors else "")) }} {% if form.gender.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.gender.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  {{ form.activity_level.label(class="form-label") }} {{
                  form.activity_level(id="activity_level", class="form-select" + (" is-invalid" if
                  form.activity_level.errors else "")) }} {% if
                  form.activity_level.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.activity_level.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.goal_type.label(class="form-label") }} {{
                  form.goal_type(id="goal_type", class="form-select" + (" is-invalid" if
                  form.goal_type.errors else "")) }} {% if form.goal_type.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.goal_type.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <div class="d-flex align-items-center gap-2 my-3">
                    <strong>Auto-Calculate Goals</strong>
                    <button type="button" id="btnCalculateGoals" class="btn btn-outline-primary btn-sm">
                      Calculate Recommended Goals
                    </button>
                    <span id="durationHint" class="text-muted">
                      Duration affects calories. Set Target Weight or we'll use a default weekly pace.
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Goal Timing Section -->
            <h6 class="mb-3 mt-4">
              <i class="fas fa-calendar-alt"></i> Goal Timeline <span class="text-muted small">(Optional)</span>
            </h6>
            
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.target_duration.label(class="form-label") }}
                  {{ form.target_duration(id="target_duration", class="form-select", onchange="updateTargetDate();") }}
                  <div class="form-text">
                    Choose how long you want to work on this goal. You can also set a custom date below.
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.target_date.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.target_date(id="target_date", class="form-control" + (" is-invalid" if form.target_date.errors else ""), onchange="handleManualDateChange()") }}
                    <button type="button" class="btn btn-outline-secondary" id="clearDateBtn" onclick="clearTargetDate()" title="Clear target date">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                  <div class="form-text">
                    This is when you aim to complete the goal. You can set it manually or let us calculate it based on the duration above.
                  </div>
                  {% if form.target_date.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.target_date.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                  
                  <!-- Past date validation error -->
                  <div id="pastDateError" class="alert alert-danger mt-2" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i> Target date cannot be in the past. Please select a future date.
                  </div>
                  
                  <!-- Dynamic feedback messages -->
                  <div id="dateAutoFillMessage" class="alert alert-info mt-2" style="display: none;">
                    <i class="fas fa-info-circle"></i> <span id="autoFillText">Auto-filled based on selected duration. You can change this date if you prefer.</span>
                  </div>
                  <div id="dateCustomMessage" class="alert alert-success mt-2" style="display: none;">
                    <i class="fas fa-check-circle"></i> <span id="customText">Custom date set. We won't change this unless you update the duration again.</span>
                  </div>
                  <div id="dateClearedMessage" class="alert alert-warning mt-2" style="display: none;">
                    <i class="fas fa-info-circle"></i> Target date removed. You can set it again anytime.
                  </div>
                  <div id="dateResetOption" class="mt-2" style="display: none;">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetToDurationDate()">
                      <i class="fas fa-undo"></i> Reset to duration-based date
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Manual Goal Setting -->
            <h6 class="mb-3">Daily Nutrition Targets:</h6>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.target_calories.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.target_calories(class="form-control" + ("
                    is-invalid" if form.target_calories.errors else ""),
                    id="targetCalories") }}
                    <span class="input-group-text">calories</span>
                  </div>
                  {% if form.target_calories.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.target_calories.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  {{ form.target_protein.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.target_protein(class="form-control" + (" is-invalid"
                    if form.target_protein.errors else ""), id="targetProtein")
                    }}
                    <span class="input-group-text">grams</span>
                  </div>
                  {% if form.target_protein.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.target_protein.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  {{ form.target_carbs.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.target_carbs(class="form-control" + (" is-invalid"
                    if form.target_carbs.errors else ""), id="targetCarbs") }}
                    <span class="input-group-text">grams</span>
                  </div>
                  {% if form.target_carbs.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.target_carbs.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  {{ form.target_fat.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.target_fat(class="form-control" + (" is-invalid" if
                    form.target_fat.errors else ""), id="targetFat") }}
                    <span class="input-group-text">grams</span>
                  </div>
                  {% if form.target_fat.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.target_fat.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  {{ form.target_fiber.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.target_fiber(class="form-control" + (" is-invalid"
                    if form.target_fiber.errors else ""), id="targetFiber") }}
                    <span class="input-group-text">grams</span>
                  </div>
                  {% if form.target_fiber.errors %}
                  <div class="invalid-feedback">
                    {% for error in form.target_fiber.errors %}
                    <span>{{ error }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <!-- Submit Button -->
            <div class="d-grid">
              {{ form.submit(class="btn btn-primary btn-lg") }}
            </div>
          </form>
        </div>
      </div>

      <!-- Goal History -->
      {% if goal_history %}
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-history"></i> Goal History
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Created</th>
                  <th>Calories</th>
                  <th>Protein</th>
                  <th>Carbs</th>
                  <th>Fat</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for goal in goal_history %}
                <tr>
                  <td>
                    {{ goal.created_at.strftime('%m/%d/%y') }}
                  </td>
                  <td>{{ goal.target_calories }}</td>
                  <td>{{ goal.target_protein }}g</td>
                  <td>{{ goal.target_carbs }}g</td>
                  <td>{{ goal.target_fat }}g</td>
                  <td>
                    {% if goal.is_active %}
                    <span class="badge bg-success">Active</span>
                    {% else %}
                    <span class="badge bg-secondary">Completed</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
  // ------- Tunable defaults (used when no target weight is set) -------
  const DEFAULT_LOSS_KG_PER_WEEK = 0.5;   // decrease per week
  const DEFAULT_GAIN_KG_PER_WEEK = 0.25;  // increase per week
  const KCAL_PER_KG = 7700;

  // ------- helpers -------
  const durationDaysMap = { '2_weeks':14,'1_month':30,'2_months':60,'3_months':90,'6_months':180,'1_year':365 };
  const byId = id => document.getElementById(id);
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function parseNum(el){
    if(!el) return NaN;
    const raw = String(el.value||'').replace(/,/g,'').trim();
    const cleaned = raw.replace(/\s*(kg|cm|g|grams|kcal|calories)?$/i,'').trim();
    const n = parseFloat(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }
  const getNum = id => parseNum(byId(id));
  const getVal = id => byId(id)?.value || '';

  function setNum(id,v){
    const el = byId(id);
    if(!el || !Number.isFinite(v)) return;
    const val = Math.round(v);
    const write = ()=>{ el.value = String(val);
      el.dispatchEvent(new Event('input',{bubbles:true}));
      el.dispatchEvent(new Event('change',{bubbles:true}));
    };
    write(); setTimeout(write,50); setTimeout(write,300);
  }

  // Accept both current + legacy keys
  const activityMap = { sedentary:1.2, light:1.375, moderate:1.55, high:1.725, very_high:1.9, active:1.725, very_active:1.9 };

  function calcBMR({gender,weight,height,age}){
    return (gender==='male')
      ? 10*weight + 6.25*height - 5*age + 5
      : 10*weight + 6.25*height - 5*age - 161;
  }

  function daysFromDurationOrDate(){
    const dur = getVal('target_duration');
    const dateStr = getVal('target_date');
    const today = new Date(); const base = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    if(dateStr){
      const dd = Math.ceil((new Date(dateStr) - base)/86400000);
      if (dd > 0) return dd;
    }
    return durationDaysMap[dur] || null;
  }

  function dailyAdjustFromDefaults(goalType, days){
    if(!days || days <= 0) return 0;
    if(goalType === 'lose') {
      const totalKg = - (DEFAULT_LOSS_KG_PER_WEEK * (days/7));
      return clamp((totalKg * KCAL_PER_KG) / days, -1000, 1000);
    }
    if(goalType === 'gain') {
      const totalKg =   (DEFAULT_GAIN_KG_PER_WEEK * (days/7));
      return clamp((totalKg * KCAL_PER_KG) / days, -1000, 1000);
    }
    return 0; // maintain
  }

  function calculateGoals(){
    const weight   = getNum('weight');
    const height   = getNum('height');
    const age      = getNum('age');
    const gender   = getVal('gender');
    const activity = getVal('activity_level');
    const goalType = getVal('goal_type');

    if([weight,height,age].some(Number.isNaN) || !gender || !activity || !goalType){
      alert('Fill weight, height, age, gender, activity level, and goal type first.');
      return;
    }

    const bmr = calcBMR({gender,weight,height,age});
    const mult = activityMap[activity] ?? 1.2;
    const tdee = bmr * mult;

    const days = daysFromDurationOrDate();
    const targetWt = getNum('target_weight');

    let dailyAdjust = 0;
    if(Number.isFinite(targetWt) && days && days > 0){
      const deltaKg = targetWt - weight; // negative => loss
      dailyAdjust = clamp((deltaKg * KCAL_PER_KG) / days, -1000, 1000);
    } else {
      // duration-aware even WITHOUT target weight: use default weekly pace
      const byPace = dailyAdjustFromDefaults(goalType, days);
      if (byPace !== 0) dailyAdjust = byPace;
      else {
        // keep legacy ±500 only if we have neither target weight nor a recognized goal pace
        if(goalType==='lose') dailyAdjust = -500;
        else if(goalType==='gain') dailyAdjust = +500;
      }
    }

    let calories = clamp(tdee + dailyAdjust, 800, 5000);
    const protein = clamp(weight * 2.2, 10, 300);
    const fat     = clamp((calories * 0.25) / 9, 0, 200);
    const carbs   = clamp((calories - protein*4 - fat*9) / 4, 0, 500);
    const fiber   = clamp((calories / 1000) * 14, 0, 100);

    setNum('targetCalories', calories);
    setNum('targetProtein',  protein);
    setNum('targetFat',      fat);
    setNum('targetCarbs',    carbs);
    setNum('targetFiber',    fiber);

    const hint = byId('durationHint');
    if(hint){
      if(Number.isFinite(targetWt) && days) {
        hint.textContent = `Using duration-aware plan: Δ${(targetWt-weight).toFixed(1)}kg over ${days} days`;
      } else if (days) {
        const pace = (goalType==='lose') ? `-${DEFAULT_LOSS_KG_PER_WEEK} kg/week`
                   : (goalType==='gain') ? `+${DEFAULT_GAIN_KG_PER_WEEK} kg/week`
                   : `0 kg/week`;
        hint.textContent = `Using default pace (${pace}) over ${days} days`;
      } else {
        hint.textContent = `Using legacy ±500 kcal/day (set duration or date for duration-aware plan)`;
      }
    }

    console.info('[Goals] tdee=', Math.round(tdee), 'dailyAdjust=', Math.round(dailyAdjust), 'cal=', Math.round(calories));
  }

  // --- date helpers and wiring (also trigger recalc) ---
  function updateTargetDate(){
    const dur = getVal('target_duration');
    const dateEl = byId('target_date'); if(!dateEl) { calculateGoals(); return; }
    const days = durationDaysMap[dur];
    if(!days){ calculateGoals(); return; }
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() + days);
    try { dateEl.valueAsDate = d; } catch(e){}
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    dateEl.value = `${yyyy}-${mm}-${dd}`;
    dateEl.dispatchEvent(new Event('input',{bubbles:true}));
    dateEl.dispatchEvent(new Event('change',{bubbles:true}));
    calculateGoals(); // auto-recalc on duration change
  }
  function handleManualDateChange(){ calculateGoals(); }

  window.updateTargetDate = updateTargetDate;
  window.handleManualDateChange = handleManualDateChange;
  window.calculateGoals = calculateGoals;

  function wire(){
    const btn = byId('btnCalculateGoals');
    if(btn){ btn.onclick = null; btn.addEventListener('click', calculateGoals, { passive:true }); }
    // Live recalc on relevant changes
    ['weight','height','age','gender','activity_level','goal_type','target_weight']
      .map(byId).filter(Boolean).forEach(el => el.addEventListener('change', calculateGoals));
    byId('target_duration')?.addEventListener('change', updateTargetDate);
    byId('target_date')?.addEventListener('change', handleManualDateChange);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', wire, { once:true });
  else wire();
})();
</script>
{% endblock %}
