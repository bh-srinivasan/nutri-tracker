{% extends "base.html" %}
{% block title %}Nutrition Goals{% endblock %}

{% block page_css %}
<style>
  /* Subtle page theming */
  .goals-hero {
    background: linear-gradient(135deg, #eef6ff, #fff);
    border-radius: .75rem;
    padding: 1.25rem 1rem;
  }
  .card-lift {
    transition: transform .15s ease, box-shadow .15s ease;
  }
  .card-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.08);
  }
  .input-unit .input-group-text { min-width: 3.5rem; justify-content: center; }
  .targets-chip {
    display:inline-flex; gap:.35rem; flex-wrap:wrap
  }
  .targets-chip .badge { font-size:.85rem; }
  .sticky-actions {
    position: sticky; bottom: 0; z-index: 5; background: #fff; padding-top:.5rem;
    border-top: 1px dashed #e9ecef;
  }
  .muted-hint { font-size: .9rem; color: #6c757d; }
</style>
{% endblock %}

{% block content %}

<div class="goals-hero d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-1">Nutrition Goals</h2>
    <div class="muted-hint">Set your target, pick a timeline, and let us estimate your daily plan.</div>
  </div>
  <a class="btn btn-outline-secondary" href="{{ url_for('dashboard.index') }}">
    <i class="bi bi-arrow-left"></i> Back to Dashboard
  </a>
</div>

{% if current_goal %}
<div class="alert alert-info d-flex align-items-center card-lift" role="alert">
  <i class="bi bi-flag me-2"></i>
  <div class="me-auto">
    <strong class="me-2">Current Goal:</strong>
    <span>{{ current_goal.target_calories }} kcal · {{ current_goal.target_protein }}g P · {{ current_goal.target_carbs }}g C · {{ current_goal.target_fat }}g F</span>
    {% if current_goal.target_fiber %}<span> · {{ current_goal.target_fiber }}g Fiber</span>{% endif %}
    {% if current_goal.target_date %}
      <span class="ms-2 badge text-bg-light">
        Target: {{ current_goal.target_date.strftime('%b %d, %Y') }}
      </span>
    {% endif %}
  </div>
  <span class="badge text-bg-primary">{{ 'Updating' if current_goal else 'Setting' }} new goals</span>
</div>
{% endif %}

<form method="POST">
<div class="row g-3">
  <!-- LEFT: Form -->
  <div class="col-lg-8">
    <div class="card card-lift">
      <div class="card-body">
        {{ form.hidden_tag() }}

        <!-- Personal Info -->
        <h5 class="mb-3"><i class="bi bi-person-vcard me-2"></i>Personal Information</h5>
        <div class="row g-3">
          <div class="col-6">
            <label class="form-label">{{ form.weight.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.weight(id="weight", class="form-control" + (" is-invalid" if form.weight.errors else "")) }}
              <span class="input-group-text">kg</span>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">{{ form.height.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.height(id="height", class="form-control" + (" is-invalid" if form.height.errors else "")) }}
              <span class="input-group-text">cm</span>
            </div>
          </div>
          <div class="col-6">
            <label class="form-label">{{ form.age.label.text }}</label>
            {{ form.age(id="age", class="form-control" + (" is-invalid" if form.age.errors else "")) }}
          </div>
          <div class="col-6">
            <label class="form-label">{{ form.gender.label.text }}</label>
            {{ form.gender(id="gender", class="form-select" + (" is-invalid" if form.gender.errors else "")) }}
          </div>
          <div class="col-6">
            <label class="form-label">{{ form.activity_level.label.text }}</label>
            {{ form.activity_level(id="activity_level", class="form-select" + (" is-invalid" if form.activity_level.errors else "")) }}
          </div>
          <div class="col-6">
            <label class="form-label">{{ form.goal_type.label.text }}</label>
            {{ form.goal_type(id="goal_type", class="form-select" + (" is-invalid" if form.goal_type.errors else "")) }}
          </div>
        </div>

        <hr class="my-4">

        <!-- Timeline -->
        <h5 class="mb-3"><i class="bi bi-calendar-range me-2"></i>Goal Timeline</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">{{ form.target_weight.label.text }} <span class="text-muted">(optional)</span></label>
            <div class="input-group input-unit">
              {{ form.target_weight(id="target_weight", class="form-control", placeholder="Target (kg)") }}
              <span class="input-group-text">kg</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ form.target_duration.label.text }}</label>
            {{ form.target_duration(id="target_duration", class="form-select", onchange="updateTargetDate();") }}
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ form.target_date.label.text }}</label>
            {{ form.target_date(id="target_date", class="form-control" + (" is-invalid" if form.target_date.errors else ""), onchange="handleManualDateChange()") }}
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="muted-hint" id="durationHint">
              Pick a duration or date. We'll compute a plan that fits your timeline.
            </div>
          </div>
        </div>

        <hr class="my-4">

        <!-- Calculated Targets -->
        <div class="d-flex align-items-center justify-content-between">
          <h5 class="mb-0"><i class="bi bi-bullseye me-2"></i>Estimated Daily Targets</h5>
          <!-- Right-aligned, crisp button -->
          <button type="button" id="btnCalculateGoals" class="btn btn-primary">
            <i class="bi bi-lightning-charge"></i> Calculate Estimated Goals
          </button>
        </div>
        <div class="row g-3 mt-1">
          <div class="col-md-6">
            <label class="form-label">{{ form.target_calories.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.target_calories(id="targetCalories", class="form-control" + (" is-invalid" if form.target_calories.errors else "")) }}
              <span class="input-group-text">kcal</span>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ form.target_protein.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.target_protein(id="targetProtein", class="form-control" + (" is-invalid" if form.target_protein.errors else "")) }}
              <span class="input-group-text">g</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.target_carbs.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.target_carbs(id="targetCarbs", class="form-control" + (" is-invalid" if form.target_carbs.errors else "")) }}
              <span class="input-group-text">g</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.target_fat.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.target_fat(id="targetFat", class="form-control" + (" is-invalid" if form.target_fat.errors else "")) }}
              <span class="input-group-text">g</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label">{{ form.target_fiber.label.text }}</label>
            <div class="input-group input-unit">
              {{ form.target_fiber(id="targetFiber", class="form-control" + (" is-invalid" if form.target_fiber.errors else "")) }}
              <span class="input-group-text">g</span>
            </div>
          </div>
        </div>

        <!-- Sticky actions (Submit) -->
        <div class="sticky-actions mt-3 pt-2">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="targets-chip">
              <span class="badge rounded-pill text-bg-light"><i class="bi bi-fire"></i> <span id="chipCalories">—</span> kcal</span>
              <span class="badge rounded-pill text-bg-light"><i class="bi bi-capsule"></i> <span id="chipProtein">—</span> g P</span>
              <span class="badge rounded-pill text-bg-light"><i class="bi bi-bag"></i> <span id="chipCarbs">—</span> g C</span>
              <span class="badge rounded-pill text-bg-light"><i class="bi bi-droplet"></i> <span id="chipFat">—</span> g F</span>
              <span class="badge rounded-pill text-bg-light"><i class="bi bi-leaf"></i> <span id="chipFiber">—</span> g Fiber</span>
            </div>
            {{ form.submit(class="btn btn-success btn-lg") }}
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- RIGHT: Summary / Tips -->
  <div class="col-lg-4">
    <div class="card card-lift mb-3">
      <div class="card-body">
        <h6 class="text-uppercase text-muted mb-2">Quick Tips</h6>
        <ul class="mb-0 small">
          <li>Use <strong>Target Weight + Duration</strong> for a tailored plan.</li>
          <li>Activity level affects your baseline calories.</li>
          <li>Recalculate after changing any inputs.</li>
        </ul>
      </div>
    </div>
    {% if goal_history %}
    <div class="card card-lift">
      <div class="card-body">
        <h6 class="text-uppercase text-muted mb-2">Goal History</h6>
        <div class="small">
          <ul class="list-unstyled mb-0">
            {% for goal in goal_history %}
            <li class="mb-1">
              <i class="bi bi-check2-circle text-success me-1"></i>
              {{ goal.created_at.strftime('%b %d, %Y') }} · {{ goal.target_calories }} kcal · {{ goal.target_protein }}g P
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
</form>

{% endblock %}

{% block scripts %}
<script>
(function(){
  // Hook into your existing calculateGoals (if present); else add a tiny proxy
  const btn = document.getElementById('btnCalculateGoals');
  if (btn) {
    btn.addEventListener('click', () => {
      (window.calculateGoals ? window.calculateGoals : () => {})();
      // animate chips after updates
      syncChips();
      showToast('Targets updated based on your inputs.');
    });
  }
  // Live recalc chips when fields change (non-blocking)
  ['targetCalories','targetProtein','targetCarbs','targetFat','targetFiber']
    .map(id => document.getElementById(id))
    .filter(Boolean)
    .forEach(el => el.addEventListener('input', syncChips));

  function syncChips(){
    const c = (id)=>document.getElementById(id)?.value || '';
    setChip('chipCalories', c('targetCalories'));
    setChip('chipProtein',  c('targetProtein'));
    setChip('chipCarbs',    c('targetCarbs'));
    setChip('chipFat',      c('targetFat'));
    setChip('chipFiber',    c('targetFiber'));
  }
  function setChip(id, val){
    const el = document.getElementById(id);
    if(!el) return;
    el.textContent = val || '—';
    el.parentElement?.classList.add('pulse');
    setTimeout(()=>el.parentElement?.classList.remove('pulse'), 250);
  }
  function showToast(msg){
    const t = document.getElementById('globalToast');
    if(!t) return;
    t.querySelector('.toast-body').textContent = msg;
    const toast = new bootstrap.Toast(t, { delay: 1400 });
    toast.show();
  }
  
  // Sync live preview on page load
  function syncChips() {
    const calories = getNum('targetCalories');
    const protein = getNum('targetProtein');
    const carbs = getNum('targetCarbs');
    const fat = getNum('targetFat');
    
    byId('live-calories').textContent = Number.isFinite(calories) ? calories : '--';
    byId('live-protein').textContent = Number.isFinite(protein) ? protein : '--';
    byId('live-carbs').textContent = Number.isFinite(carbs) ? carbs : '--';
    byId('live-fat').textContent = Number.isFinite(fat) ? fat : '--';
  }

  // Update live chips when form values change
  function updateChipsFromForm() {
    const targets = ['targetCalories', 'targetProtein', 'targetCarbs', 'targetFat'];
    const liveMap = {
      'targetCalories': 'live-calories',
      'targetProtein': 'live-protein', 
      'targetCarbs': 'live-carbs',
      'targetFat': 'live-fat'
    };
    
    targets.forEach(target => {
      const el = byId(target);
      const liveEl = byId(liveMap[target]);
      if (el && liveEl) {
        el.addEventListener('input', () => {
          const val = getNum(target);
          liveEl.textContent = Number.isFinite(val) ? val : '--';
        });
      }
    });
  }

  // Success toast after form submission
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    
    let container = document.querySelector('.toast-container');
    if (!container) {
      container = document.createElement('div');
      container.className = 'toast-container position-fixed top-0 end-0 p-3';
      document.body.appendChild(container);
    }
    
    container.appendChild(toast);
    const t = new bootstrap.Toast(toast, { delay: 1400 });
    toast.show();
  }
  // Initial
  syncChips();
})();
</script>
{% endblock %}
