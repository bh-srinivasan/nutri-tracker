<!-- Jobs Table -->
{% if jobs and jobs.items %}
<div class="card">
  <div class="card-header">
    <div
      class="d-flex justify-content-between align-items-center"
    >
      <h5 class="mb-0">Recent Upload Jobs</h5>
      <small class="text-muted">
        Showing {{ jobs.items|length }} of {{ jobs.total }} jobs
      </small>
    </div>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table
        class="table table-striped table-hover mb-0"
        id="jobsTable"
      >
        <thead class="table-dark">
          <tr>
            <th scope="col">Job ID</th>
            <th scope="col">Filename</th>
            <th scope="col">Status</th>
            <th scope="col">Progress</th>
            <th scope="col">Total Rows</th>
            <th scope="col">Success</th>
            <th scope="col">Failed</th>
            <th scope="col">Created</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs.items %}
          <tr
            data-job-id="{{ job.job_id }}"
            class="job-row {% if job.status == 'processing' %}table-warning{% endif %}"
          >
            <td>
              <code class="small">{{ job.job_id[:8] }}...</code>
            </td>
            <td>
              <i class="fas fa-utensils text-muted me-2"></i>
              {{ job.filename }}
            </td>
            <td>
              {% if job.status == 'completed' %}
              <span class="badge bg-success">
                <i class="fas fa-check me-1"></i>{{
                job.status.title() }}
              </span>
              {% elif job.status == 'failed' %}
              <span class="badge bg-danger">
                <i class="fas fa-times me-1"></i>{{
                job.status.title() }}
              </span>
              {% elif job.status == 'processing' %}
              <span class="badge bg-warning text-dark">
                <i class="fas fa-spinner fa-spin me-1"></i>{{
                job.status.title() }}
              </span>
              {% else %}
              <span class="badge bg-secondary">
                <i class="fas fa-clock me-1"></i>{{
                job.status.title() }}
              </span>
              {% endif %}
            </td>
            <td>
              {% set progress = ((job.processed_rows /
              job.total_rows * 100) if job.total_rows > 0 else
              0) | round %}
              <div
                class="progress"
                style="width: 100px; height: 8px"
              >
                <div
                  class="progress-bar {% if job.status == 'completed' %}bg-success {% elif job.status == 'failed' %}bg-danger {% elif job.status == 'processing' %}bg-warning {% else %}bg-secondary{% endif %}"
                  data-progress="{{ progress }}"
                  role="progressbar"
                  aria-valuenow="{{ progress }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
              </div>
              <small class="text-muted">{{ progress }}%</small>
            </td>
            <td>{{ job.total_rows or 0 }}</td>
            <td>
              <span class="text-success"
                >{{ job.successful_rows or 0 }}</span
              >
            </td>
            <td>
              <span class="text-danger"
                >{{ job.failed_rows or 0 }}</span
              >
            </td>
            <td>
              <small
                title="{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') }}"
              >
                {{ job.created_at.strftime('%m/%d %H:%M') }}
              </small>
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button
                  type="button"
                  class="btn btn-outline-primary view-details-btn"
                  data-job-id="{{ job.job_id }}"
                  title="View detailed results"
                >
                  <i class="fas fa-eye"></i>
                </button>
                {% if job.status == 'processing' %}
                <button
                  type="button"
                  class="btn btn-outline-info refresh-job-btn"
                  data-job-id="{{ job.job_id }}"
                  title="Refresh status"
                >
                  <i class="fas fa-sync-alt"></i>
                </button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
{% if jobs.pages > 1 %}
<nav aria-label="Upload jobs pagination" class="mt-4">
  <ul class="pagination justify-content-center">
    {% if jobs.has_prev %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('admin.food_servings_uploads', tab='history', page=jobs.prev_num) }}"
      >
        <i class="fas fa-chevron-left"></i> Previous
      </a>
    </li>
    {% endif %} {% for page_num in jobs.iter_pages() %} {% if
    page_num %} {% if page_num != jobs.page %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('admin.food_servings_uploads', tab='history', page=page_num) }}"
        >{{ page_num }}</a
      >
    </li>
    {% else %}
    <li class="page-item active">
      <span class="page-link">{{ page_num }}</span>
    </li>
    {% endif %} {% else %}
    <li class="page-item disabled">
      <span class="page-link">...</span>
    </li>
    {% endif %} {% endfor %} {% if jobs.has_next %}
    <li class="page-item">
      <a
        class="page-link"
        href="{{ url_for('admin.food_servings_uploads', tab='history', page=jobs.next_num) }}"
      >
        Next <i class="fas fa-chevron-right"></i>
      </a>
    </li>
    {% endif %}
  </ul>
</nav>
{% endif %} {% else %}
<!-- No Jobs State -->
<div class="text-center py-5">
  <i class="fas fa-utensils fa-4x text-muted mb-3"></i>
  <h5 class="text-muted mb-3">No upload jobs found</h5>
  <p class="text-muted mb-4">
    Start by uploading your first serving data file
  </p>
  <a
    href="{{ url_for('admin.food_servings_uploads', tab='upload') }}"
    class="btn btn-primary"
  >
    <i class="fas fa-upload me-2"></i>Upload Serving Data
  </a>
</div>
{% endif %}

<!-- JavaScript for History Tab -->
<script>
  let historyRefreshInterval;

  function initializeHistoryTab() {
    // Auto-refresh for active jobs
    startAutoRefresh();

    // Progress bar animations
    animateProgressBars();

    // Add event handlers
    document.querySelectorAll('.view-details-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const jobId = this.dataset.jobId;
        viewJobDetails(jobId);
      });
    });

    document.querySelectorAll('.refresh-job-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const jobId = this.dataset.jobId;
        refreshJobStatus(jobId);
      });
    });
  }

  function startAutoRefresh() {
    // Clear any existing interval
    if (historyRefreshInterval) {
      clearInterval(historyRefreshInterval);
    }

    // Check if there are any processing jobs
    const processingJobs = document.querySelectorAll('.job-row.table-warning');
    
    if (processingJobs.length > 0) {
      historyRefreshInterval = setInterval(function() {
        // Refresh status for each processing job
        processingJobs.forEach(function(row) {
          const jobId = row.dataset.jobId;
          refreshJobStatus(jobId, false); // Silent refresh
        });
      }, 3000); // Every 3 seconds
    }
  }

  function animateProgressBars() {
    document.querySelectorAll('.progress-bar').forEach(function(bar) {
      const progress = bar.dataset.progress || 0;
      
      // Set initial width to 0
      bar.style.width = '0%';
      
      // Animate to target width
      setTimeout(function() {
        bar.style.transition = 'width 0.6s ease-in-out';
        bar.style.width = progress + '%';
      }, 100);
    });
  }

  function refreshJobStatus(jobId, showSpinner = true) {
    const row = document.querySelector(`[data-job-id="${jobId}"]`);
    if (!row) return;

    if (showSpinner) {
      // Show loading state
      const refreshBtn = row.querySelector('.refresh-job-btn i');
      if (refreshBtn) {
        refreshBtn.classList.add('fa-spin');
      }
    }

    fetch(`/admin/food-servings/status/${jobId}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          console.error('Error refreshing job status:', data.error);
          return;
        }

        updateJobRow(row, data);
        
        // If job completed, stop auto-refresh and reload page
        if (data.status === 'completed' || data.status === 'failed') {
          if (historyRefreshInterval) {
            clearInterval(historyRefreshInterval);
          }
          // Reload to get updated counts and final status
          setTimeout(() => location.reload(), 1000);
        }
      })
      .catch(error => {
        console.error('Error refreshing job status:', error);
      })
      .finally(() => {
        if (showSpinner) {
          // Remove loading state
          const refreshBtn = row.querySelector('.refresh-job-btn i');
          if (refreshBtn) {
            refreshBtn.classList.remove('fa-spin');
          }
        }
      });
  }

  function updateJobRow(row, data) {
    // Update status badge
    const statusCell = row.cells[2];
    let statusBadge = '';
    
    if (data.status === 'completed') {
      statusBadge = '<span class="badge bg-success"><i class="fas fa-check me-1"></i>Completed</span>';
      row.classList.remove('table-warning');
    } else if (data.status === 'failed') {
      statusBadge = '<span class="badge bg-danger"><i class="fas fa-times me-1"></i>Failed</span>';
      row.classList.remove('table-warning');
    } else if (data.status === 'processing') {
      statusBadge = '<span class="badge bg-warning text-dark"><i class="fas fa-spinner fa-spin me-1"></i>Processing</span>';
      row.classList.add('table-warning');
    } else {
      statusBadge = '<span class="badge bg-secondary"><i class="fas fa-clock me-1"></i>Pending</span>';
    }
    statusCell.innerHTML = statusBadge;

    // Update progress
    const progressCell = row.cells[3];
    const progressBar = progressCell.querySelector('.progress-bar');
    const progressText = progressCell.querySelector('small');
    
    if (progressBar && data.progress_percentage !== undefined) {
      progressBar.style.width = data.progress_percentage + '%';
      progressBar.setAttribute('aria-valuenow', data.progress_percentage);
      progressBar.dataset.progress = data.progress_percentage;
      
      // Update progress bar color based on status
      progressBar.className = 'progress-bar';
      if (data.status === 'completed') {
        progressBar.classList.add('bg-success');
      } else if (data.status === 'failed') {
        progressBar.classList.add('bg-danger');
      } else if (data.status === 'processing') {
        progressBar.classList.add('bg-warning');
      } else {
        progressBar.classList.add('bg-secondary');
      }
    }
    
    if (progressText) {
      progressText.textContent = (data.progress_percentage || 0) + '%';
    }

    // Update counts if provided
    if (data.total_rows !== undefined) {
      row.cells[4].textContent = data.total_rows;
    }
    if (data.successful_rows !== undefined) {
      row.cells[5].innerHTML = `<span class="text-success">${data.successful_rows}</span>`;
    }
    if (data.failed_rows !== undefined) {
      row.cells[6].innerHTML = `<span class="text-danger">${data.failed_rows}</span>`;
    }

    // Update action buttons
    const actionsCell = row.cells[8];
    if (data.status !== 'processing') {
      // Remove refresh button if job is no longer processing
      const refreshBtn = actionsCell.querySelector('.refresh-job-btn');
      if (refreshBtn) {
        refreshBtn.remove();
      }
    }
  }

  function viewJobDetails(jobId) {
    // Create and show modal with job details
    const modal = new bootstrap.Modal(document.createElement('div'));
    
    // For now, show a simple alert - this can be enhanced later
    fetch(`/admin/food-servings/status/${jobId}`)
      .then(response => response.json())
      .then(data => {
        let details = `Job ID: ${jobId}\n`;
        details += `Status: ${data.status}\n`;
        details += `Progress: ${data.progress_percentage || 0}%\n`;
        details += `Total Rows: ${data.total_rows || 0}\n`;
        details += `Successful: ${data.successful_rows || 0}\n`;
        details += `Failed: ${data.failed_rows || 0}\n`;
        
        if (data.error_message) {
          details += `\nError: ${data.error_message}`;
        }
        
        alert(details);
      })
      .catch(error => {
        console.error('Error fetching job details:', error);
        alert('Error fetching job details');
      });
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('jobsTable')) {
      initializeHistoryTab();
    }
  });

  // Clean up interval when page unloads
  window.addEventListener('beforeunload', function() {
    if (historyRefreshInterval) {
      clearInterval(historyRefreshInterval);
    }
  });
</script>
