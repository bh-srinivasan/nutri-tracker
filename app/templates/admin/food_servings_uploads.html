{% extends "base.html" %} {% block title %}Food Servings Upload - Admin{% endblock %} {%
block content %}
<div class="container-fluid mt-4">
  <div class="row justify-content-center">
    <div class="col-12">
      <!-- Header Section -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
          <i class="fas fa-utensils fa-2x text-primary me-3"></i>
          <div>
            <h1 class="h3 mb-0">Food Servings Upload</h1>
            <p class="text-muted mb-0">
              Manage bulk serving size uploads and track processing status
            </p>
          </div>
        </div>
        <div class="btn-group" role="group">
          <a
            href="{{ url_for('admin.dashboard') }}"
            class="btn btn-outline-secondary"
          >
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
          </a>
        </div>
      </div>

      <!-- Navigation Tabs -->
      <div class="card shadow-sm">
        <div class="card-header border-0 bg-light">
          <ul
            class="nav nav-pills card-header-pills"
            id="uploadTabs"
            role="tablist"
          >
            <li class="nav-item" role="presentation">
              <a
                class="nav-link {{ 'active' if active_tab == 'upload' else '' }}"
                href="{{ url_for('admin.food_servings_uploads', tab='upload') }}"
                title="Upload new serving data files"
              >
                <i class="fas fa-upload me-2"></i>Upload Serving Data
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a
                class="nav-link {{ 'active' if active_tab == 'history' else '' }}"
                href="{{ url_for('admin.food_servings_uploads', tab='history') }}"
                title="View upload history and job status"
              >
                <i class="fas fa-history me-2"></i>Upload History {% if
                pending_jobs_count > 0 %}
                <span class="badge bg-warning text-dark ms-2"
                  >{{ pending_jobs_count }}</span
                >
                {% endif %}
              </a>
            </li>
          </ul>
        </div>

        <div class="card-body p-0">
          <div class="tab-content" id="uploadTabsContent">
            <!-- Upload Serving Data Panel -->
            {% if active_tab == 'upload' %}
            <div
              class="tab-pane fade show active"
              id="upload-panel"
              role="tabpanel"
              aria-labelledby="upload-tab"
              tabindex="0"
            >
              {% include 'admin/_food_servings_upload_form.html' %}
            </div>
            {% endif %}

            <!-- Upload History Panel -->
            {% if active_tab == 'history' %}
            <div
              class="tab-pane fade show active"
              id="history-panel"
              role="tabpanel"
              aria-labelledby="history-tab"
              tabindex="0"
            >
              <div class="p-4">
                <!-- History Header -->
                <div
                  class="d-flex justify-content-between align-items-center mb-4"
                >
                  <div>
                    <h4 class="mb-1">Upload History</h4>
                    <p class="text-muted mb-0">
                      Track the status and progress of your serving data uploads
                    </p>
                  </div>
                  <div class="btn-group" role="group">
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      id="refreshJobsBtn"
                      title="Refresh job status"
                      onclick="window.location.reload()"
                    >
                      <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <a
                      href="{{ url_for('admin.food_servings_uploads', tab='upload') }}"
                      class="btn btn-outline-secondary"
                      title="Start a new upload"
                    >
                      <i class="fas fa-plus me-2"></i>New Upload
                    </a>
                  </div>
                </div>

                {% include 'admin/_food_servings_upload_history.html' %}
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Job Details Modal -->
<div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jobDetailsModalLabel">Upload Job Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="jobDetailsContent">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Job details modal function
function showJobDetails(jobId) {
    const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
    const content = document.getElementById('jobDetailsContent');
    
    // Show loading spinner
    content.innerHTML = `
        <div class="d-flex justify-content-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    
    modal.show();
    
    // Fetch job details
    fetch(`?action=job_details&job_id=${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                content.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }
            
            const job = data.job;
            const statusBadgeClass = job.status === 'completed' ? 'success' : 
                                   job.status === 'failed' ? 'danger' : 
                                   job.status === 'processing' ? 'warning' : 'secondary';
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Basic Information</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Filename:</strong></td>
                                <td>${job.filename}</td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td><span class="badge bg-${statusBadgeClass}">${job.status}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Created:</strong></td>
                                <td>${job.created_at}</td>
                            </tr>
                            ${job.started_at ? `<tr><td><strong>Started:</strong></td><td>${job.started_at}</td></tr>` : ''}
                            ${job.completed_at ? `<tr><td><strong>Completed:</strong></td><td>${job.completed_at}</td></tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Progress</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Total Rows:</strong></td>
                                <td>${job.total_rows}</td>
                            </tr>
                            <tr>
                                <td><strong>Processed:</strong></td>
                                <td>${job.processed_rows}</td>
                            </tr>
                            <tr>
                                <td><strong>Successful:</strong></td>
                                <td class="text-success">${job.successful_rows}</td>
                            </tr>
                            <tr>
                                <td><strong>Failed:</strong></td>
                                <td class="text-danger">${job.failed_rows}</td>
                            </tr>
                        </table>
                        ${job.total_rows > 0 ? `
                            <div class="mt-2">
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${job.progress_percentage}%" 
                                         aria-valuenow="${job.progress_percentage}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        ${job.progress_percentage}%
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ${job.error_message ? `
                    <div class="mt-3">
                        <h6>Error Details</h6>
                        <div class="alert alert-danger">
                            <pre class="mb-0">${job.error_message}</pre>
                        </div>
                    </div>
                ` : ''}
            `;
        })
        .catch(error => {
            content.innerHTML = `<div class="alert alert-danger">Error loading job details: ${error.message}</div>`;
        });
}

// Auto-refresh for pending/processing jobs
document.addEventListener('DOMContentLoaded', function() {
    const historyTable = document.querySelector('table[data-auto-refresh]');
    if (!historyTable) return;
    
    // Check if there are any pending or processing jobs
    const pendingRows = historyTable.querySelectorAll('tr[data-job-id]');
    const hasPendingJobs = Array.from(pendingRows).some(row => {
        const statusBadge = row.querySelector('.badge');
        return statusBadge && ['Pending', 'Processing'].includes(statusBadge.textContent.trim());
    });
    
    if (hasPendingJobs) {
        const refreshInterval = setInterval(() => {
            fetch('?action=status_check')
                .then(response => response.json())
                .then(data => {
                    if (data.jobs) {
                        data.jobs.forEach(job => {
                            const row = document.querySelector(`tr[data-job-id="${job.job_id}"]`);
                            if (row) {
                                // Update status badge
                                const statusBadge = row.querySelector('.badge');
                                if (statusBadge) {
                                    const badgeClass = job.status === 'completed' ? 'bg-success' : 
                                                     job.status === 'failed' ? 'bg-danger' : 
                                                     job.status === 'processing' ? 'bg-warning' : 'bg-secondary';
                                    statusBadge.className = `badge ${badgeClass}`;
                                    statusBadge.textContent = job.status.charAt(0).toUpperCase() + job.status.slice(1);
                                }
                                
                                // Update progress bar
                                const progressBar = row.querySelector('.progress-bar');
                                if (progressBar) {
                                    progressBar.style.width = `${job.progress_percentage}%`;
                                    progressBar.textContent = `${job.progress_percentage}%`;
                                }
                                
                                // If job is completed or failed, stop auto-refreshing this row
                                if (['completed', 'failed'].includes(job.status)) {
                                    const remainingPending = document.querySelectorAll('tr[data-job-id] .badge').length;
                                    const stillPending = Array.from(document.querySelectorAll('tr[data-job-id] .badge')).some(badge => 
                                        ['Pending', 'Processing'].includes(badge.textContent.trim())
                                    );
                                    
                                    if (!stillPending) {
                                        clearInterval(refreshInterval);
                                    }
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error refreshing job status:', error);
                });
        }, 3000); // Refresh every 3 seconds
    }
});
</script>
{% endblock %}
